{% extends "base.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
{% endblock %}
{% block title %}
Add new case
{% endblock %}

{% block content %}

<main class="container-fluid" style="margin:50px 0px">
    <h3>General case info form</h3>
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="locations" id="location_input" value="">
        <div class="row ml-2">
            <div class="col">
                <div class="row">
                    <div class="col">
                        <label for="fname">Assigned police</label>
                        <select class="form-container form-control" name="allowed_polices" id="police">
                            {% for p in police_list %}
                                <option value="{{ p.pk }}">{{ p.profile.first_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 my-2">
                        <label for="severity">Crime Type</label>
                        <select class="form-container form-control" name="crime_type" id="severity">
                            {% for ct in case_types %}
                                <option value="{{ ct.pk }}">{{ ct.crime }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-12 my-2">
                        <label for="description">Case description</label>
                        <textarea class="form-control" id="description" name="case_description" rows="7"></textarea>
                    </div>
                    <!-- <div class="col-md-12 my-2">
                        <label for="category">Case Category</label>
                        <select name="category" class="form-control">
                            <option value="Fraud">Fraud</option>
                        </select>
                    </div> -->
                </div>
            </div>
            <div class="col">
                <div class="row">
                    <div class="form-group col-md-12">
                        <label for="evidence">Evidence/Evidences</label>
                        <input type="file" name="evidence" class="form-control" multiple id="evidence">
                    </div>
                    <div class="form-group col-md-12">
                        <label for="location">Add location</label>
                        <input type="button" onclick="displayModalMap()" class="btn btn-primary form-control" data-toggle="modal"
                            data-target="#locationModal" value="Add location">
                    </div>
                    
                </div>
            </div>
        </div>
        <button class="mx-auto btn btn-primary mt-3" id="submit_Cbtn" style="width: 200px;">Submit</button>
    </form>
</main>

<!-- The Modal -->
<div class="modal" id="locationModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="width: 800px; position: fixed; top: 50px; left: -130px;">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <div class="modal-body" style="display: inherit;">
                <div id="mapId" style="width:800px; height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>

    var markers = []
    var markerOptions = {
        clickable: true,
        draggable: true
    }

    var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
    });

    function createMarker(coords) {
        var id
        if (markers.length < 1) id = 0
        else id = markers[markers.length - 1]._id + 1
        var popupContent = '<button onclick="clearMarker(' + id + ')">Clear Marker</button>';
        myMarker = L.marker(coords, {
            draggable: true,
            icon:redIcon
        });
        myMarker._id = id
        var myPopup = myMarker.bindPopup(popupContent, {
            closeButton: false
        });
        map.addLayer(myMarker)
        markers.push(myMarker)
    }

    function clearMarker(id) {
        console.log(markers)
        var new_markers = []
        markers.forEach(function(marker) {
            if (marker._id == id) map.removeLayer(marker)
            else new_markers.push(marker)
        })
        markers = new_markers
    }

    function append_location(coord){
        var lat = coord.lat 
        var lng = coord.lng 
        l_input = document.getElementById('location_input')
        if (l_input.value == ""){
            l_input.value = "" + lat + "," + lng 
        } else{
            l_input.value += ";" + lat + "," + lng 
        }
        
    }

    function addMarker(e){
        createMarker(e.latlng)
        append_location(e.latlng)
        return
        c_location = e.latlng
        var marker = L.marker(e.latlng,markerOptions)
        console.log(location)
        marker.addTo(map)
        lat = c_location.lat
        lng = c_location.lng 
    }

    var mapOptions = {
        center: [8.9806, 38.7578], // lat,long #A.A [8.9806, 38.7578]
        zoom: 13
    }

    var map = new L.map('mapId', mapOptions);
    var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    map.addLayer(layer);

    map.on('click',addMarker)

    function displayModalMap(){
        document.getElementById('locationModal').style.display = 'block';
        setTimeout(function() {
            map.invalidateSize();
        }, 100);
    }

</script>

{% endblock %}